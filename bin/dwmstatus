#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

DEBUG=${DEBUG:-""}

BAT=BAT1
IWIFACE=wlp3s0
DE_DATA_DIR="${XDG_DATA_HOME}/de"
PID_FILE="$DE_DATA_DIR/dwmstatus.pid"

_volume() {
  ponymix is-muted

  if [ $? -eq 0 ]; then
    echo "🔇 MUTE| "
  else
    local volume=$(ponymix get-volume)
    echo "🔊 ${volume}%"
  fi
}

_ifstatus() {
  local ipaddr=$(ip addr | grep enp3s0: -A2 | tail -n1 | awk '{print $2}' | cut -d/ -f1)

  echo -en "📶 $ipaddr"
}

_date() {
  date +"%F %R"
}

_recording() {
  if [ -f "$DE_DATA_DIR/gifcast.pid" ]; then
    echo -n " | ⏺ REC"
  fi
}

_set_status() {
  status=" $(_volume) | $(_ifstatus) | $(_date)$(_recording)"
  if [ -n "$DEBUG" ]; then
    echo "> update status"
    echo $status
  else
    xsetroot -name "$status"
  fi
}

_restart() {
  if [ -n "$DEBUG" ]; then
    echo "> restarting"
  fi
  notify-send --expire-time 1000 --icon system-run "Restarting dwmstatus"
  exec /home/madx/bin/dwmstatus $@
}

_refresh() {
  if [ -n "$DEBUG" ]; then
    echo "> force refresh"
  fi
  _set_status
}

trap _restart ALRM
trap _refresh WINCH

command=${1:-run}

case "$command" in
  restart)
    kill -ALRM $(cat "$PID_FILE")
    ;;
  refresh)
    kill -WINCH $(cat "$PID_FILE")
    ;;
  run)
    echo -n $$ > "$PID_FILE"
    while true; do
      _set_status
      sleep 1
    done
    ;;
esac

